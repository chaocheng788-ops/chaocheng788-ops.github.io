<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>销售明细表 - 飞书多选打印版（241mm×279.4mm）</title>
    <!-- 飞书插件适配依赖（核心：获取表格数据） -->
    <!-- 替换方案1：飞书官方国内CDN（推荐） -->
<script src="https://cdn.jsdelivr.net/npm/@lark-base-open/js-sdk@1.2.0/dist/index.umd.min.js"></script>
    <style>
        /* 基础样式：适配241mm×279.4mm多联打印纸 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "仿宋", "SimSun", serif; /* 针式打印兼容字体 */
        }
        body {
            width: 241mm; /* 多联纸标准宽度 */
            padding: 8mm 10mm; /* 多联纸边距（上下8mm，左右10mm） */
            margin: 0 auto;
            background: #fff;
            font-size: 13px; /* 针式打印清晰字体大小 */
            line-height: 1.4; /* 紧凑行高 */
        }

        /* 打印专用样式（多联针式打印优化） */
        @media print {
            body {
                padding: 0;
                margin: 0;
                width: 100%;
                height: auto; /* 连续走纸自适应高度 */
            }
            @page {
                size: 241mm 279.4mm; /* 明确多联纸尺寸 */
                margin: 8mm 10mm; /* 打印边距与页面一致 */
                orphans: 2; /* 避免表格行顶部单独分页 */
                widows: 2; /* 避免表格行底部单独分页 */
                @top-center: none; /* 取消默认页眉 */
                @bottom-center: none; /* 取消默认页脚 */
            }
            .no-print {
                display: none !important; /* 隐藏非打印元素 */
            }
            table {
                page-break-inside: auto; /* 支持表格跨页打印 */
            }
            th, td {
                border-color: #000 !important;
                border-width: 0.8px !important; /* 边框加粗适配复写 */
            }
        }

        /* 单据标题 */
        .title {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            letter-spacing: 1px;
        }

        /* 基础信息区域（紧凑网格布局） */
        .base-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px 15px;
            margin-bottom: 10px;
            border-bottom: 1px solid #000;
            padding-bottom: 8px;
        }
        .info-item {
            display: flex;
            align-items: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .info-label {
            width: 75px;
            font-weight: 600;
            flex-shrink: 0;
        }
        .info-value {
            flex: 1;
            border-bottom: 1px dashed #333;
            padding: 1px 0;
            min-height: 18px;
        }

        /* 商品明细表格（固定布局+字段适配） */
        .detail-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            table-layout: fixed; /* 固定列宽避免错乱 */
        }
        .detail-table th, .detail-table td {
            border: 1px solid #000;
            padding: 6px 3px;
            text-align: center;
            vertical-align: middle;
            font-size: 12px;
            word-break: break-all; /* 长文本换行 */
        }
        .detail-table th {
            font-weight: bold;
        }
        /* 表格列宽分配（适配241mm宽度） */
        .detail-table th:nth-child(1), td:nth-child(1) { width: 12%; } /* 物料编码 */
        .detail-table th:nth-child(2), td:nth-child(2) { width: 12%; } /* 物料名称 */
        .detail-table th:nth-child(3), td:nth-child(3) { width: 18%; } /* 规格型号 */
        .detail-table th:nth-child(4), td:nth-child(4) { width: 6%; }  /* 单位 */
        .detail-table th:nth-child(5), td:nth-child(5) { width: 8%; }  /* 数量 */
        .detail-table th:nth-child(6), td:nth-child(6) { width: 12%; } /* 单价 */
        .detail-table th:nth-child(7), td:nth-child(7) { width: 12%; } /* 金额 */
        .detail-table th:nth-child(8), td:nth-child(8) { width: 20%; } /* 备注 */
        .detail-table .remark {
            text-align: left;
            padding-left: 5px;
        }

        /* 合计区域 */
        .total-area {
            margin: 10px 0;
            text-align: right;
            font-size: 14px;
        }
        .total-amount {
            font-size: 15px;
            font-weight: bold;
            color: #000; /* 纯黑适配多联复写 */
            margin-left: 8px;
        }
        .amount-capital {
            margin-top: 4px;
            font-weight: 600;
        }

        /* 底部信息 */
        .footer {
            margin-top: 15px;
            font-size: 12px;
            color: #333;
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
        }
        .footer-left {
            text-align: left;
            width: 60%;
        }
        .footer-right {
            text-align: right;
            width: 40%;
        }

        /* 操作按钮（飞书环境适配） */
        .btn-group {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 9999;
            display: flex;
            gap: 10px;
        }
        .print-btn, .refresh-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            color: #fff;
        }
        .print-btn {
            background: #007fff;
        }
        .print-btn:hover {
            background: #0066cc;
        }
        .refresh-btn {
            background: #4CAF50;
        }
        .refresh-btn:hover {
            background: #3d8b40;
        }

        /* 提示信息（飞书环境专用） */
        .tip {
            margin: 10px 0;
            padding: 8px;
            background: #f5f5f5;
            border-left: 3px solid #007fff;
            font-size: 12px;
            color: #333;
        }
        .error-tip {
            background: #fff8f8;
            border-left: 3px solid #d32f2f;
            color: #d32f2f;
        }
    </style>
</head>
<body>
    <!-- 操作按钮（飞书内可见，打印隐藏） -->
    <div class="btn-group no-print">
        <button class="refresh-btn" onclick="loadSelectedData()">刷新选中数据</button>
        <button class="print-btn" onclick="printDocument()">打印选中数据</button>
    </div>

    <!-- 飞书环境提示（非打印元素） -->
    <div class="tip no-print">
        操作说明：1. 在飞书多维表格中选中要打印的行；2. 点击「刷新选中数据」加载数据；3. 确认无误后点击「打印选中数据」
    </div>
    <div id="errorTip" class="tip error-tip no-print" style="display: none;"></div>

    <!-- 单据内容 -->
    <div class="invoice-container">
        <!-- 标题 -->
        <div class="title">河南省飞马起重机械集团有限公司销售明细表</div>

        <!-- 基础信息（可手动编辑或从飞书表格获取） -->
        <div class="base-info">
            <div class="info-item">
                <span class="info-label">发票号：</span>
                <span class="info-value" id="invoiceNo" contenteditable="true">2511054292</span>
            </div>
            <div class="info-item">
                <span class="info-label">发货日期：</span>
                <span class="info-value" id="shipDate" contenteditable="true">2025年11月28日</span>
            </div>
            <div class="info-item">
                <span class="info-label">销售经理：</span>
                <span class="info-value" id="salesManager" contenteditable="true">韩瑞鹏</span>
            </div>
            <div class="info-item">
                <span class="info-label">审核人员：</span>
                <span class="info-value" id="checker" contenteditable="true">韩瑞鹏</span>
            </div>
            <div class="info-item">
                <span class="info-label">发货人：</span>
                <span class="info-value" id="shipper" contenteditable="true">韩烁星（15670503456）</span>
            </div>
            <div class="info-item">
                <span class="info-label">收款方式：</span>
                <span class="info-value" id="paymentMethod" contenteditable="true">单</span>
            </div>
            <div class="info-item">
                <span class="info-label">客户名称：</span>
                <span class="info-value" id="customerName" contenteditable="true">中原公司靳庆余</span>
            </div>
            <div class="info-item">
                <span class="info-label">客户电话：</span>
                <span class="info-value" id="customerPhone" contenteditable="true">18603739577</span>
            </div>
        </div>

        <!-- 商品明细表格（动态渲染选中数据） -->
        <table class="detail-table">
            <thead>
                <tr>
                    <th>物料编码</th>
                    <th>物料名称</th>
                    <th>规格型号</th>
                    <th>单位</th>
                    <th>数量</th>
                    <th>单价（元）</th>
                    <th>金额（元）</th>
                    <th>备注</th>
                </tr>
            </thead>
            <tbody id="detailTableBody">
                <!-- 动态数据将在这里渲染 -->
                <tr>
                    <td colspan="8" style="text-align: center; color: #666;">请在飞书表格中选中数据后，点击「刷新选中数据」</td>
                </tr>
            </tbody>
        </table>

        <!-- 合计区域（自动计算） -->
        <div class="total-area">
            <div>
                数量合计：<span id="totalQuantity">0.00</span> 吨&nbsp;&nbsp;&nbsp;&nbsp;
                金额合计：<span class="total-amount" id="totalAmount">¥0.00</span>
            </div>
            <div class="amount-capital">
                大写金额：<span id="capitalAmount">零元整</span>
            </div>
            <div style="margin-top: 4px; font-size: 12px;">说明：此金额为含税价</div>
        </div>

        <!-- 底部信息 -->
        <div class="footer">
            <div class="footer-left">
                打印时间：<span id="printTime">2025年11月28日 09:47</span><br>
                单据联次：共4联（留存/客户/记账/会计）
            </div>
            <div class="footer-right">
                第 <span id="pageNum">1</span> 页 / 共 <span id="totalPage">1</span> 页
            </div>
        </div>
    </div>

    <script>
        // ========================= 核心配置：飞书表格字段映射 =========================
        // 请根据你的飞书表格字段ID修改以下映射（字段ID可在飞书表格「字段设置」中查看）
        const FIELD_MAPPING = {
            materialCode: "fld6mvGmkP", // 飞书表格「物料编码」字段ID
            materialName: "fldTRySYAT", // 飞书表格「物料名称」字段ID
            specification: "fldxxxxxxxxxxxx3", // 飞书表格「规格型号」字段ID
            unit: "fldxxxxxxxxxxxx4", // 飞书表格「单位」字段ID（默认吨）
            quantity: "fldxxxxxxxxxxxx5", // 飞书表格「数量」字段ID
            unitPrice: "fldxxxxxxxxxxxx6", // 飞书表格「单价」字段ID
            amount: "fldxxxxxxxxxxxx7", // 飞书表格「金额」字段ID（可选，若没有则自动计算）
            remark: "fldxxxxxxxxxxxx8" // 飞书表格「备注」字段ID（可选）
        };
        // ===========================================================================

        // 金额大写转换工具
        function convertToCapital(amount) {
            const digits = ['零', '壹', '贰', '叁', '肆', '伍', '陆', '柒', '捌', '玖'];
            const units = ['', '拾', '佰', '仟', '万', '拾', '佰', '仟', '亿'];
            const decimals = ['角', '分'];
            let integerPart = Math.floor(amount);
            let decimalPart = Math.round((amount - integerPart) * 100);
            
            let capital = '';
            if (integerPart === 0) {
                capital = '零';
            } else {
                let str = integerPart.toString();
                for (let i = 0; i < str.length; i++) {
                    const digit = parseInt(str[i]);
                    const pos = str.length - 1 - i;
                    if (digit !== 0) {
                        capital += digits[digit] + units[pos];
                    } else {
                        if (pos % 4 !== 0 || (i > 0 && parseInt(str[i-1]) !== 0)) {
                            capital += digits[digit];
                        }
                    }
                }
            }
            capital += '元';
            if (decimalPart === 0) {
                capital += '整';
            } else {
                if (Math.floor(decimalPart / 10) > 0) {
                    capital += digits[Math.floor(decimalPart / 10)] + decimals[0];
                } else if (integerPart !== 0) {
                    capital += '零';
                }
                if (decimalPart % 10 > 0) {
                    capital += digits[decimalPart % 10] + decimals[1];
                }
            }
            return capital;
        }

        // 加载飞书表格选中行数据
        async function loadSelectedData() {
            const errorTip = document.getElementById('errorTip');
            const tableBody = document.getElementById('detailTableBody');
            
            try {
                // 1. 检查飞书SDK是否加载成功
                if (!window.bitable || !window.bitable.base) {
                    throw new Error('飞书SDK加载失败，请在飞书多维表格中使用该插件');
                }

                // 2. 获取当前活跃表格
                const table = await window.bitable.base.getActiveTable();
                if (!table) {
                    throw new Error('未找到当前活跃表格，请打开飞书多维表格后重试');
                }

                // 3. 获取选中的记录（行数据）
                const selectedRecords = await table.getSelectedRecords();
                if (selectedRecords.length === 0) {
                    throw new Error('未选中任何数据，请在表格中选择要打印的行后重试');
                }

                // 4. 验证字段映射是否完整（核心字段必须配置）
                const requiredFields = ['materialCode', 'materialName', 'specification', 'quantity', 'unitPrice'];
                const missingFields = requiredFields.filter(key => !FIELD_MAPPING[key] || FIELD_MAPPING[key].includes('xxxx'));
                if (missingFields.length > 0) {
                    throw new Error(`请配置飞书表格字段映射：${missingFields.join('、')}（修改代码中FIELD_MAPPING配置）`);
                }

                // 5. 处理选中数据，渲染表格
                let totalQuantity = 0; // 总数量
                let totalAmount = 0;   // 总金额
                let tableHtml = '';

                for (const record of selectedRecords) {
                    const fields = record.fields;
                    // 提取字段值（适配飞书表格字段类型）
                    const materialCode = fields[FIELD_MAPPING.materialCode] || '';
                    const materialName = fields[FIELD_MAPPING.materialName] || '';
                    const specification = fields[FIELD_MAPPING.specification] || '';
                    const unit = fields[FIELD_MAPPING.unit] || '吨'; // 默认单位为吨
                    const quantity = parseFloat(fields[FIELD_MAPPING.quantity]) || 0;
                    const unitPrice = parseFloat(fields[FIELD_MAPPING.unitPrice]) || 0;
                    const amount = fields[FIELD_MAPPING.amount] ? parseFloat(fields[FIELD_MAPPING.amount]) : (quantity * unitPrice); // 金额优先取表格值，无则计算
                    const remark = fields[FIELD_MAPPING.remark] || '';

                    // 累加合计
                    totalQuantity += quantity;
                    totalAmount += amount;

                    // 生成表格行
                    tableHtml += `
                        <tr>
                            <td>${materialCode}</td>
                            <td>${materialName}</td>
                            <td>${specification}</td>
                            <td>${unit}</td>
                            <td>${quantity.toFixed(2)}</td>
                            <td>${unitPrice.toFixed(2)}</td>
                            <td>${amount.toFixed(2)}</td>
                            <td class="remark">${remark}</td>
                        </tr>
                    `;
                }

                // 6. 更新表格和合计信息
                tableBody.innerHTML = tableHtml;
                document.getElementById('totalQuantity').textContent = totalQuantity.toFixed(2);
                document.getElementById('totalAmount').textContent = `¥${totalAmount.toFixed(2)}`;
                document.getElementById('capitalAmount').textContent = convertToCapital(totalAmount);
                errorTip.style.display = 'none';

            } catch (err) {
                // 异常处理：显示错误提示
                errorTip.textContent = `错误：${err.message}`;
                errorTip.style.display = 'block';
                tableBody.innerHTML = `<tr><td colspan="8" style="text-align: center; color: #d32f2f;">${err.message}</td></tr>`;
            }
        }

        // 打印功能（飞书/浏览器兼容）
        function printDocument() {
            const tableBody = document.getElementById('detailTableBody');
            const errorTip = document.getElementById('errorTip');

            // 检查是否有有效数据
            if (tableBody.querySelector('td[colspan="8"]') || tableBody.children.length === 0) {
                errorTip.textContent = '错误：无有效打印数据，请先加载选中数据';
                errorTip.style.display = 'block';
                return;
            }

            // 飞书环境优先使用飞书打印API
            if (window.bitable && window.bitable.base) {
                try {
                    window.bitable.base.print({
                        success: () => console.log('飞书打印触发成功'),
                        fail: (err) => {
                            console.error('飞书打印失败，切换为浏览器打印：', err);
                            window.print();
                        }
                    });
                } catch (e) {
                    console.warn('飞书打印API调用失败，使用浏览器打印：', e);
                    window.print();
                }
            } else {
                window.print();
            }
        }

        // 初始化：更新打印时间 + 检查飞书环境
        window.onload = function() {
            // 更新当前打印时间
            const now = new Date();
            const formatTime = `${now.getFullYear()}年${now.getMonth()+1}月${now.getDate()}日 ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            document.getElementById('printTime').textContent = formatTime;

            // 飞书环境自动尝试加载选中数据（可选）
            if (window.bitable && window.bitable.base) {
                setTimeout(() => {
                    loadSelectedData().catch(() => {}); // 失败不提示，避免干扰用户
                }, 1000);
            }
        };
    </script>
</body>
</html>
