// ==================== 核心函数 ====================

// 核心改造：通过selectRecordIdList唤起选择对话框获取记录ID并加载数据
async function loadSelectedData() {
    const errorTip = document.getElementById('errorTip');
    const tableBody = document.getElementById('detailTableBody');
    
    try {
        // ========== 步骤1：检查SDK加载状态 ==========
        console.log('【步骤1】检查飞书SDK加载状态');
        if (!window.bitable || !window.bitable.base || !window.bitable.ui) {
            throw new Error('飞书SDK加载失败，请确认lark-sdk.umd.js文件路径正确');
        }
        console.log('✅ SDK加载成功，bitable对象：', window.bitable);

        // ========== 步骤2：获取base实例 ==========
        console.log('【步骤2】获取base实例');
        const base = window.bitable.base;
        if (!base) {
            throw new Error('未获取到base实例，请确认在飞书多维表格环境中运行');
        }
        console.log('✅ base实例获取成功：', base);

        // ========== 步骤3：获取tableId和viewId ==========
        console.log('【步骤3】获取当前活跃表格的tableId和viewId');
        const selection = await base.getSelection();
        console.log('原始selection数据：', selection);
        
        let tableId = selection?.tableId;
        let viewId = selection?.viewId;
        
        // 兼容：如果selection中没有，从活跃表格获取
        if (!tableId) {
            const activeTable = await base.getActiveTable();
            tableId = activeTable?.id;
            viewId = activeTable?.activeViewId || viewId;
        }
        
        if (!tableId || !viewId) {
            throw new Error('未获取到tableId或viewId，请先打开飞书多维表格的具体视图');
        }
        console.log(`✅ tableId和viewId获取成功：tableId=${tableId}, viewId=${viewId}`);

        // ========== 步骤4：调用selectRecordIdList唤起选择对话框 ==========
        console.log('【步骤4】调用bitable.ui.selectRecordIdList唤起记录选择对话框');
        const selectedRecordIds = await window.bitable.ui.selectRecordIdList(tableId, viewId);
        console.log('✅ 选择对话框返回的recordId列表：', selectedRecordIds);

        // 验证选中结果
        if (!selectedRecordIds || selectedRecordIds.length === 0) {
            throw new Error('未在对话框中选择任何记录，请重新选择');
        }
        console.log(`✅ 共选中 ${selectedRecordIds.length} 条记录`);

        // ========== 步骤5：获取当前活跃表格实例 ==========
        console.log('【步骤5】获取当前活跃表格实例');
        const table = await base.getActiveTable();
        if (!table) {
            throw new Error('未找到当前活跃表格');
        }
        console.log('✅ 表格实例获取成功：', table);

        // ========== 步骤6：获取表格所有记录 ==========
        console.log('【步骤6】获取表格所有记录');
        let allRecords = await table.getRecordList();
        console.log('原始getRecordList返回值：', allRecords, '类型：', typeof allRecords, '是否数组：', Array.isArray(allRecords));

        // 关键调整：优先提取recordList
        if (!Array.isArray(allRecords)) {
            if (allRecords?.recordList && Array.isArray(allRecords.recordList)) {
                allRecords = allRecords.recordList;
            }
            else if (allRecords?.records && Array.isArray(allRecords.records)) {
                allRecords = allRecords.records;
            } else if (allRecords?.data && Array.isArray(allRecords.data)) {
                allRecords = allRecords.data;
            }
            else {
                allRecords = [];
            }
            console.log('转换后的allRecords数组：', allRecords, '长度：', allRecords.length);
        }

        if (allRecords.length === 0) {
            console.warn('⚠️ 警告：表格记录数组为空');
        } else {
            console.log(`✅ 成功提取记录数组，共 ${allRecords.length} 条记录`);
        }

        // ========== 步骤7：筛选选中的记录 ==========
        console.log('【步骤7】筛选选中的记录（根据recordId列表）');
        // 打印第一条记录的结构，确认fields字段
        if (allRecords.length > 0) {
            console.log('第一条记录的完整结构：', allRecords[0]);
            console.log('第一条记录的fields字段：', allRecords[0].fields);
            console.log('fields字段的所有键名：', Object.keys(allRecords[0].fields || {}));
        }

        // 修正筛选条件：使用recordId字段（根据实际情况调整）
        const selectedRecords = allRecords.filter(record => {
            const recordId = record.recordId || record.id || record._id;
            
            if (!recordId) {
                console.warn('⚠️ 跳过无id的异常记录：', record);
                return false;
            }
            return selectedRecordIds.includes(recordId);
        });

        console.log(`✅ 筛选出选中的记录，共 ${selectedRecords.length} 条`);

        if (selectedRecords.length === 0) {
            throw new Error('未找到匹配的记录，请检查字段映射');
        }

        // ========== 步骤8：处理数据并渲染 ==========
        console.log('【步骤8】处理数据并渲染');
        let totalAmount = 0;
        let totalQuantity = 0;
        let tableHtml = '';
        let taxRemark = '';

        // 清空不需要展示的字段
        document.getElementById('deliveryDriver').textContent = '';
        document.getElementById('customerAddress').textContent = '';

        // 遍历选中记录
        for (let i = 0; i < selectedRecords.length; i++) {
            const record = selectedRecords[i];
            const fields = record.fields || {};
            console.log(`处理第 ${i+1} 条记录，fields：`, fields);

            // 如果是第一条记录，提取去重展示的字段
            if (i === 0) {
                console.log('=== 提取去重展示字段 ===');
                
                // 发票号：fldFRpsxIn.text
                const invoiceNo = extractField(fields, 'fldFRpsxIn') || '';
                console.log('提取发票号:', invoiceNo);
                document.getElementById('invoiceNo').textContent = invoiceNo;
                
                // 发货日期：fldXDRjMOt[0]（时间戳转日期）
                const timestamp = extractField(fields, 'fldXDRjMOt');
                console.log('提取时间戳:', timestamp);
                const shipDate = timestampToDate(timestamp);
                document.getElementById('shipDate').textContent = shipDate;
                
                // 销售经理：fldD0DvgRD[0].text
                const salesManager = extractField(fields, 'fldD0DvgRD') || '';
                console.log('提取销售经理:', salesManager);
                document.getElementById('salesManager').textContent = salesManager;
                
                // 送货司机：fldpmnkxAJ[0].text
                const deliveryDriver = extractField(fields, 'fldpmnkxAJ') || '';
                console.log('提取送货司机:', deliveryDriver);
                document.getElementById('deliveryDriver').textContent = deliveryDriver;
                
                // 客户名称：fldfsZTsu9[0].text
                const customerName = extractField(fields, 'fldfsZTsu9') || '';
                console.log('提取客户名称:', customerName);
                document.getElementById('customerName').textContent = customerName;
                
                // 客户地址：fldc76DtjW[0].text
                const customerAddress = extractField(fields, 'fldc76DtjW') || '';
                console.log('提取客户地址:', customerAddress);
                document.getElementById('customerAddress').textContent = customerAddress;
                
                // 含税说明：fldzNp2Gpg[0].text
                const taxType = extractField(fields, 'fldzNp2Gpg') || '';
                console.log('提取税类型:', taxType);
                if (taxType === '含税') {
                    taxRemark = '说明：此金额为含税价';
                }
            }

            // 提取表格行字段（去掉物料编码）
            console.log('=== 提取表格行字段 ===');
            
            // 物料名称：fldZRE1MMR
            const materialName = extractField(fields, 'fldZRE1MMR') || '';
            console.log('物料名称:', materialName);
            
            // 规格型号：fldTRySYAT
            const specification = extractField(fields, 'fldTRySYAT') || '';
            console.log('规格型号:', specification);
            
            // 单位：fldNQg0P9l
            const unit = extractField(fields, 'fldNQg0P9l') || '';
            console.log('单位:', unit);
            
            // 数值字段直接获取
            const quantity = parseFloat(fields.fldLgfZ4zt) || 0;
            console.log('数量:', quantity, '原始值:', fields.fldLgfZ4zt);
            
            const unitPrice = parseFloat(fields.fldIeO9wYh) || 0;
            console.log('单价:', unitPrice, '原始值:', fields.fldIeO9wYh);
            
            const amount = parseFloat(fields.fldPnhczuU) || 0;
            console.log('金额:', amount, '原始值:', fields.fldPnhczuU);
            
            // 原有备注
            const originalRemark = fields.fldQSFfBoE || '';
            console.log('原有备注:', originalRemark);
            
            // 新增逻辑：提取fld48sccKI数组字段的第一个元素的text值
            let additionalRemark = '';
            const fld48sccKI = fields.fld48sccKI;
            console.log('fld48sccKI字段值:', fld48sccKI);
            
            if (fld48sccKI && Array.isArray(fld48sccKI) && fld48sccKI.length > 0) {
                const firstElement = fld48sccKI[0];
                if (firstElement && typeof firstElement === 'object' && firstElement.text) {
                    additionalRemark = firstElement.text;
                    console.log('提取到fld48sccKI第一个元素的text值:', additionalRemark);
                }
            }
            
            // 拼接备注：原有备注 + 空格 + 新增内容
            let finalRemark = originalRemark;
            if (additionalRemark) {
                if (originalRemark) {
                    finalRemark = originalRemark + ' ' + additionalRemark;
                } else {
                    finalRemark = additionalRemark;
                }
            }
            console.log('最终备注:', finalRemark);

            // 累加合计金额和数量
            totalQuantity += quantity;
            totalAmount += amount;

            // 生成表格行HTML（7列）
            tableHtml += `
                <tr>
                    <td>${materialName}</td>
                    <td>${specification}</td>
                    <td>${unit}</td>
                    <td>${quantity.toFixed(3)}</td>
                    <td>${unitPrice.toFixed(2)}</td>
                    <td>${amount.toFixed(2)}</td>
                    <td class="remark">${finalRemark}</td>
                </tr>
            `;
        }

        // ========== 步骤9：生成表格合计行 ==========
        console.log('【步骤9】生成表格合计行');
        const capitalAmount = convertToCapital(totalAmount);
        
        // 添加表格合计行 - 调整列结构
        // 第一列：显示"合计"
        // 第二列：金额大写（向左合并单位列，colspan="2"）
        // 第三列：合计数量（对齐数量列）
        // 第四列：空（单价列）
        // 第五列：合计金额（对齐金额列）
        // 第六列：空（备注列）
        tableHtml += `
            <tr class="total-row">
                <td>合计</td>
                <td class="capital-amount" colspan="2">${capitalAmount}</td>
                <td>${totalQuantity.toFixed(3)}</td>
                <td></td>
                <td>${totalAmount.toFixed(2)}</td>
                <td></td>
            </tr>
        `;

        // ========== 步骤10：更新页面显示 ==========
        console.log('【步骤10】更新页面显示');
        // 更新表格内容
        tableBody.innerHTML = tableHtml;
        
        // 更新底部合计区域
        document.getElementById('totalAmount').textContent = `¥${totalAmount.toFixed(2)}`;
        document.getElementById('capitalAmount').textContent = capitalAmount;
        document.getElementById('taxRemark').textContent = taxRemark;
        
        // 更新打印时间
        updatePrintTime();
        
        // 隐藏错误提示
        errorTip.style.display = 'none';

        console.log('✅ 所有数据加载完成，合计数量：', totalQuantity.toFixed(3), '合计金额：', totalAmount.toFixed(2));

    } catch (err) {
        // 异常处理：显示错误提示 + 控制台打印
        console.error('❌ 加载数据失败：', err);
        errorTip.textContent = `错误：${err.message}`;
        errorTip.style.display = 'block';
        tableBody.innerHTML = `<tr><td colspan="7" style="text-align: center; color: #d32f2f;">${err.message}</td></tr>`;
    }
}
