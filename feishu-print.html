// ========== 步骤8：处理数据并渲染 ==========
console.log('【步骤8】处理数据并渲染');
let totalAmount = 0;
let tableHtml = '';
let taxRemark = '';

// 清空不需要展示的字段
document.getElementById('deliveryDriver').textContent = '';
document.getElementById('customerAddress').textContent = '';

// 遍历选中记录
for (let i = 0; i < selectedRecords.length; i++) {
    const record = selectedRecords[i];
    const fields = record.fields || {};
    console.log(`处理第 ${i+1} 条记录，fields：`, fields);

    // 如果是第一条记录，提取去重展示的字段
    if (i === 0) {
        // ... 保持不变 ...
    }

    // 提取表格行字段（去掉物料编码）
    console.log('=== 提取表格行字段 ===');
    
    // 物料名称：fldZRE1MMR
    const materialName = extractField(fields, 'fldZRE1MMR') || '';
    console.log('物料名称:', materialName);
    
    // 规格型号：fldTRySYAT
    const specification = extractField(fields, 'fldTRySYAT') || '';
    console.log('规格型号:', specification);
    
    // 单位：fldNQg0P9l
    const unit = extractField(fields, 'fldNQg0P9l') || '';
    console.log('单位:', unit);
    
    // 数值字段直接获取
    const quantity = parseFloat(fields.fldLgfZ4zt) || 0;
    console.log('数量:', quantity, '原始值:', fields.fldLgfZ4zt);
    
    const unitPrice = parseFloat(fields.fldIeO9wYh) || 0;
    console.log('单价:', unitPrice, '原始值:', fields.fldIeO9wYh);
    
    const amount = parseFloat(fields.fldPnhczuU) || 0;
    console.log('金额:', amount, '原始值:', fields.fldPnhczuU);
    
    // === 新增逻辑开始 ===
    // 获取原有备注
    let originalRemark = fields.fldQSFfBoE || '';
    console.log('原始备注:', originalRemark);
    
    // 提取fld48sccKI字段的第一个元素的text值
    let extraRemark = '';
    const fld48sccKIValue = fields.fld48sccKI;
    console.log('fld48sccKI字段原始值:', fld48sccKIValue);
    
    if (fld48sccKIValue) {
        if (Array.isArray(fld48sccKIValue) && fld48sccKIValue.length > 0) {
            // 获取第一个元素
            const firstElement = fld48sccKIValue[0];
            console.log('fld48sccKI第一个元素:', firstElement);
            
            // 提取text字段值
            if (firstElement && typeof firstElement === 'object' && firstElement.text !== undefined) {
                extraRemark = firstElement.text;
                console.log('提取到的extraRemark:', extraRemark);
            } else if (typeof firstElement === 'string') {
                extraRemark = firstElement;
                console.log('提取到的extraRemark(字符串):', extraRemark);
            }
        } else if (typeof fld48sccKIValue === 'object' && fld48sccKIValue.text !== undefined) {
            // 如果不是数组，直接取text
            extraRemark = fld48sccKIValue.text;
            console.log('提取到的extraRemark(对象):', extraRemark);
        } else if (typeof fld48sccKIValue === 'string') {
            extraRemark = fld48sccKIValue;
            console.log('提取到的extraRemark(字符串):', extraRemark);
        }
    }
    
    // 拼接备注：原有备注 + 新增内容（如果有）
    let finalRemark = originalRemark;
    if (extraRemark) {
        // 如果原有备注不为空，添加分隔符
        if (originalRemark) {
            finalRemark = originalRemark + '；' + extraRemark;
        } else {
            finalRemark = extraRemark;
        }
    }
    console.log('最终备注:', finalRemark);
    // === 新增逻辑结束 ===

    // 累加合计金额
    totalAmount += amount;

    // 生成表格行HTML（7列） - 使用finalRemark替换原来的remark
    tableHtml += `
        <tr>
            <td>${materialName}</td>
            <td>${specification}</td>
            <td>${unit}</td>
            <td>${quantity.toFixed(2)}</td>
            <td>${unitPrice.toFixed(2)}</td>
            <td>${amount.toFixed(2)}</td>
            <td class="remark">${finalRemark}</td>
        </tr>
    `;
}
