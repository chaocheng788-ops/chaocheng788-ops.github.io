<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>销售明细表 - 飞书多选打印版（241mm×279.4mm）</title>
    <!-- 修正：引用转换后的UMD格式SDK（之前转换的lark-sdk.umd.js） -->
   <script src="lark-sdk.umd.js" defer></script>
    <style>
        /* 原有样式保持不变 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "仿宋", "SimSun", serif;
        }
        body {
            width: 241mm;
            padding: 8mm 10mm;
            margin: 0 auto;
            background: #fff;
            font-size: 13px;
            line-height: 1.4;
        }
        @media print {
            body {
                padding: 0;
                margin: 0;
                width: 100%;
                height: auto;
            }
            @page {
                size: 241mm 279.4mm;
                margin: 8mm 10mm;
                orphans: 2;
                widows: 2;
                @top-center: none;
                @bottom-center: none;
            }
            .no-print {
                display: none !important;
            }
            table {
                page-break-inside: auto;
            }
            th, td {
                border-color: #000 !important;
                border-width: 0.8px !important;
            }
        }
        .title {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            letter-spacing: 1px;
        }
        .base-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px 15px;
            margin-bottom: 10px;
            border-bottom: 1px solid #000;
            padding-bottom: 8px;
        }
        .info-item {
            display: flex;
            align-items: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .info-label {
            width: 75px;
            font-weight: 600;
            flex-shrink: 0;
        }
        .info-value {
            flex: 1;
            border-bottom: 1px dashed #333;
            padding: 1px 0;
            min-height: 18px;
        }
        .detail-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            table-layout: fixed;
        }
        .detail-table th, .detail-table td {
            border: 1px solid #000;
            padding: 6px 3px;
            text-align: center;
            vertical-align: middle;
            font-size: 12px;
            word-break: break-all;
        }
        .detail-table th {
            font-weight: bold;
        }
        .detail-table th:nth-child(1), td:nth-child(1) { width: 12%; }
        .detail-table th:nth-child(2), td:nth-child(2) { width: 12%; }
        .detail-table th:nth-child(3), td:nth-child(3) { width: 18%; }
        .detail-table th:nth-child(4), td:nth-child(4) { width: 6%; }
        .detail-table th:nth-child(5), td:nth-child(5) { width: 8%; }
        .detail-table th:nth-child(6), td:nth-child(6) { width: 12%; }
        .detail-table th:nth-child(7), td:nth-child(7) { width: 12%; }
        .detail-table th:nth-child(8), td:nth-child(8) { width: 20%; }
        .detail-table .remark {
            text-align: left;
            padding-left: 5px;
        }
        .total-area {
            margin: 10px 0;
            text-align: right;
            font-size: 14px;
        }
        .total-amount {
            font-size: 15px;
            font-weight: bold;
            color: #000;
            margin-left: 8px;
        }
        .amount-capital {
            margin-top: 4px;
            font-weight: 600;
        }
        .footer {
            margin-top: 15px;
            font-size: 12px;
            color: #333;
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
        }
        .footer-left {
            text-align: left;
            width: 60%;
        }
        .footer-right {
            text-align: right;
            width: 40%;
        }
        .btn-group {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 9999;
            display: flex;
            gap: 10px;
        }
        .print-btn, .refresh-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            color: #fff;
        }
        .print-btn {
            background: #007fff;
        }
        .print-btn:hover {
            background: #0066cc;
        }
        .refresh-btn {
            background: #4CAF50;
        }
        .refresh-btn:hover {
            background: #3d8b40;
        }
        .tip {
            margin: 10px 0;
            padding: 8px;
            background: #f5f5f5;
            border-left: 3px solid #007fff;
            font-size: 12px;
            color: #333;
        }
        .error-tip {
            background: #fff8f8;
            border-left: 3px solid #d32f2f;
            color: #d32f2f;
        }
    </style>
</head>
<body>
    <!-- 操作按钮 -->
    <div class="btn-group no-print">
        <button class="refresh-btn" onclick="loadSelectedData()">刷新选中数据</button>
        <button class="print-btn" onclick="printDocument()">打印选中数据</button>
    </div>

    <!-- 提示信息 -->
    <div class="tip no-print">
        操作说明：1. 在飞书多维表格中选中要打印的行；2. 点击「刷新选中数据」加载数据；3. 确认无误后点击「打印选中数据」
    </div>
    <div id="errorTip" class="tip error-tip no-print" style="display: none;"></div>

    <!-- 单据内容 -->
    <div class="invoice-container">
        <div class="title">河南省飞马起重机械集团有限公司销售明细表</div>

        <div class="base-info">
            <div class="info-item">
                <span class="info-label">发票号：</span>
                <span class="info-value" id="invoiceNo" contenteditable="true">2511054292</span>
            </div>
            <div class="info-item">
                <span class="info-label">发货日期：</span>
                <span class="info-value" id="shipDate" contenteditable="true">2025年11月28日</span>
            </div>
            <div class="info-item">
                <span class="info-label">销售经理：</span>
                <span class="info-value" id="salesManager" contenteditable="true">韩瑞鹏</span>
            </div>
            <div class="info-item">
                <span class="info-label">审核人员：</span>
                <span class="info-value" id="checker" contenteditable="true">韩瑞鹏</span>
            </div>
            <div class="info-item">
                <span class="info-label">发货人：</span>
                <span class="info-value" id="shipper" contenteditable="true">韩烁星（15670503456）</span>
            </div>
            <div class="info-item">
                <span class="info-label">收款方式：</span>
                <span class="info-value" id="paymentMethod" contenteditable="true">单</span>
            </div>
            <div class="info-item">
                <span class="info-label">客户名称：</span>
                <span class="info-value" id="customerName" contenteditable="true">中原公司靳庆余</span>
            </div>
            <div class="info-item">
                <span class="info-label">客户电话：</span>
                <span class="info-value" id="customerPhone" contenteditable="true">18603739577</span>
            </div>
        </div>

        <table class="detail-table">
            <thead>
                <tr>
                    <th>物料编码</th>
                    <th>物料名称</th>
                    <th>规格型号</th>
                    <th>单位</th>
                    <th>数量</th>
                    <th>单价（元）</th>
                    <th>金额（元）</th>
                    <th>备注</th>
                </tr>
            </thead>
            <tbody id="detailTableBody">
                <tr>
                    <td colspan="8" style="text-align: center; color: #666;">请在飞书表格中选中数据后，点击「刷新选中数据」</td>
                </tr>
            </tbody>
        </table>

        <div class="total-area">
            <div>
                数量合计：<span id="totalQuantity">0.00</span> 吨&nbsp;&nbsp;&nbsp;&nbsp;
                金额合计：<span class="total-amount" id="totalAmount">¥0.00</span>
            </div>
            <div class="amount-capital">
                大写金额：<span id="capitalAmount">零元整</span>
            </div>
            <div style="margin-top: 4px; font-size: 12px;">说明：此金额为含税价</div>
        </div>

        <div class="footer">
            <div class="footer-left">
                打印时间：<span id="printTime">2025年11月28日 09:47</span><br>
                单据联次：共4联（留存/客户/记账/会计）
            </div>
            <div class="footer-right">
                第 <span id="pageNum">1</span> 页 / 共 <span id="totalPage">1</span> 页
            </div>
        </div>
    </div>

    <script>
        // 核心配置：飞书表格字段映射（必须修改为你的表格实际字段ID！）
        const FIELD_MAPPING = {
            materialCode: "fld6mvGmkP", // 替换为「物料编码」字段ID
            materialName: "fldTRySYAT", // 替换为「物料名称」字段ID
            specification: "fld6mvGmkP", // 替换为「规格型号」字段ID
            unit: "fld6mvGmkP", // 替换为「单位」字段ID
            quantity: "fld6mvGmkP", // 替换为「数量」字段ID
            unitPrice: "fld6mvGmkP", // 替换为「单价」字段ID
            amount: "fld6mvGmkP", // 替换为「金额」字段ID（可选）
            remark: "fld6mvGmkP" // 替换为「备注」字段ID（可选）
        };

        // 金额大写转换工具（保持不变）
        function convertToCapital(amount) {
            const digits = ['零', '壹', '贰', '叁', '肆', '伍', '陆', '柒', '捌', '玖'];
            const units = ['', '拾', '佰', '仟', '万', '拾', '佰', '仟', '亿'];
            const decimals = ['角', '分'];
            let integerPart = Math.floor(amount);
            let decimalPart = Math.round((amount - integerPart) * 100);
            
            let capital = '';
            if (integerPart === 0) {
                capital = '零';
            } else {
                let str = integerPart.toString();
                for (let i = 0; i < str.length; i++) {
                    const digit = parseInt(str[i]);
                    const pos = str.length - 1 - i;
                    if (digit !== 0) {
                        capital += digits[digit] + units[pos];
                    } else {
                        if (pos % 4 !== 0 || (i > 0 && parseInt(str[i-1]) !== 0)) {
                            capital += digits[digit];
                        }
                    }
                }
            }
            capital += '元';
            if (decimalPart === 0) {
                capital += '整';
            } else {
                if (Math.floor(decimalPart / 10) > 0) {
                    capital += digits[Math.floor(decimalPart / 10)] + decimals[0];
                } else if (integerPart !== 0) {
                    capital += '零';
                }
                if (decimalPart % 10 > 0) {
                    capital += digits[decimalPart % 10] + decimals[1];
                }
            }
            return capital;
        }

        // 加载飞书表格选中行数据（核心修正：替换方法名和变量名）
        async function loadSelectedData() {
            const errorTip = document.getElementById('errorTip');
            const tableBody = document.getElementById('detailTableBody');
            
            try {
                // 1. 检查飞书SDK是否加载成功
                if (!window.bitable || !window.bitable.base) {
                    throw new Error('飞书SDK加载失败，请确认lark-sdk.umd.js文件路径正确');
                }

                // 2. 获取当前活跃表格
                const table = await window.bitable.base.getActiveTable();
                if (!table) {
                    throw new Error('未找到当前活跃表格，请打开飞书多维表格后重试');
                }

                // 核心修正：将getSelectedRecords()改为飞书正确方法getSelectedRows()
                const selectedRows = await table.getSelectedRows();
                if (selectedRows.length === 0) {
                    throw new Error('未选中任何数据，请在表格中选择要打印的行后重试');
                }

                // 4. 验证字段映射是否完整
                const requiredFields = ['materialCode', 'materialName', 'specification', 'quantity', 'unitPrice'];
                const missingFields = requiredFields.filter(key => !FIELD_MAPPING[key] || FIELD_MAPPING[key].includes('xxxx'));
                if (missingFields.length > 0) {
                    throw new Error(`请配置飞书表格字段映射：${missingFields.join('、')}（修改代码中FIELD_MAPPING配置）`);
                }

                // 5. 处理选中数据，渲染表格（变量名同步改为selectedRows）
                let totalQuantity = 0;
                let totalAmount = 0;
                let tableHtml = '';

                for (const row of selectedRows) { // 这里变量名从record改为row，更贴合飞书的行概念
                    const fields = row.fields; // 飞书行数据的字段仍通过fields获取，格式不变
                    // 提取字段值（适配飞书表格字段类型）
                    const materialCode = fields[FIELD_MAPPING.materialCode] || '';
                    const materialName = fields[FIELD_MAPPING.materialName] || '';
                    const specification = fields[FIELD_MAPPING.specification] || '';
                    const unit = fields[FIELD_MAPPING.unit] || '吨';
                    const quantity = parseFloat(fields[FIELD_MAPPING.quantity]) || 0;
                    const unitPrice = parseFloat(fields[FIELD_MAPPING.unitPrice]) || 0;
                    const amount = fields[FIELD_MAPPING.amount] ? parseFloat(fields[FIELD_MAPPING.amount]) : (quantity * unitPrice);
                    const remark = fields[FIELD_MAPPING.remark] || '';

                    // 累加合计
                    totalQuantity += quantity;
                    totalAmount += amount;

                    // 生成表格行
                    tableHtml += `
                        <tr>
                            <td>${materialCode}</td>
                            <td>${materialName}</td>
                            <td>${specification}</td>
                            <td>${unit}</td>
                            <td>${quantity.toFixed(2)}</td>
                            <td>${unitPrice.toFixed(2)}</td>
                            <td>${amount.toFixed(2)}</td>
                            <td class="remark">${remark}</td>
                        </tr>
                    `;
                }

                // 6. 更新表格和合计信息
                tableBody.innerHTML = tableHtml;
                document.getElementById('totalQuantity').textContent = totalQuantity.toFixed(2);
                document.getElementById('totalAmount').textContent = `¥${totalAmount.toFixed(2)}`;
                document.getElementById('capitalAmount').textContent = convertToCapital(totalAmount);
                errorTip.style.display = 'none';

            } catch (err) {
                // 异常处理
                errorTip.textContent = `错误：${err.message}`;
                errorTip.style.display = 'block';
                tableBody.innerHTML = `<tr><td colspan="8" style="text-align: center; color: #d32f2f;">${err.message}</td></tr>`;
            }
        }

        // 打印功能（保持不变）
        function printDocument() {
            const tableBody = document.getElementById('detailTableBody');
            const errorTip = document.getElementById('errorTip');

            if (tableBody.querySelector('td[colspan="8"]') || tableBody.children.length === 0) {
                errorTip.textContent = '错误：无有效打印数据，请先加载选中数据';
                errorTip.style.display = 'block';
                return;
            }

            if (window.bitable && window.bitable.base) {
                try {
                    window.bitable.base.print({
                        success: () => console.log('飞书打印触发成功'),
                        fail: (err) => {
                            console.error('飞书打印失败，切换为浏览器打印：', err);
                            window.print();
                        }
                    });
                } catch (e) {
                    console.warn('飞书打印API调用失败，使用浏览器打印：', e);
                    window.print();
                }
            } else {
                window.print();
            }
        }

        // 初始化（保持不变）
        window.onload = function() {
            const now = new Date();
            const formatTime = `${now.getFullYear()}年${now.getMonth()+1}月${now.getDate()}日 ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            document.getElementById('printTime').textContent = formatTime;

            if (window.bitable && window.bitable.base) {
                setTimeout(() => {
                    loadSelectedData().catch(() => {});
                }, 1000);
            }
        };
    </script>
</body>
</html>
