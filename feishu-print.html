<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>销售明细表 - 飞书多选打印版（241mm×279.4mm）</title>
    <!-- 引用转换后的UMD格式SDK（确保与HTML同目录） -->
   <script src="lark-sdk.umd.js" defer></script>
    <style>
        /* 基础样式：适配241mm×279.4mm多联打印纸 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "仿宋", "SimSun", serif;
        }
        body {
            width: 241mm;
            padding: 8mm 10mm;
            margin: 0 auto;
            background: #fff;
            font-size: 13px;
            line-height: 1.4;
        }

        /* 打印专用样式优化 */
        @media print {
            body {
                padding: 0;
                margin: 0;
                width: 100%;
                height: auto;
            }
            @page {
                size: 241mm 279.4mm;
                margin: 8mm 10mm;
                orphans: 2;
                widows: 2;
                @top-center: none;
                @bottom-center: none;
            }
            .no-print {
                display: none !important;
            }
            table {
                page-break-inside: auto;
            }
            th, td {
                border-color: #000 !important;
                border-width: 0.8px !important;
            }
        }

        /* 单据标题 */
        .title {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            letter-spacing: 1px;
        }

        /* 基础信息区域 */
        .base-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px 15px;
            margin-bottom: 10px;
            border-bottom: 1px solid #000;
            padding-bottom: 8px;
        }
        .info-item {
            display: flex;
            align-items: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .info-label {
            width: 75px;
            font-weight: 600;
            flex-shrink: 0;
        }
        .info-value {
            flex: 1;
            border-bottom: 1px dashed #333;
            padding: 1px 0;
            min-height: 18px;
        }

        /* 商品明细表格 */
        .detail-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            table-layout: fixed;
        }
        .detail-table th, .detail-table td {
            border: 1px solid #000;
            padding: 6px 3px;
            text-align: center;
            vertical-align: middle;
            font-size: 12px;
            word-break: break-all;
        }
        .detail-table th {
            font-weight: bold;
        }
        /* 表格列宽分配 */
        .detail-table th:nth-child(1), td:nth-child(1) { width: 12%; }
        .detail-table th:nth-child(2), td:nth-child(2) { width: 12%; }
        .detail-table th:nth-child(3), td:nth-child(3) { width: 18%; }
        .detail-table th:nth-child(4), td:nth-child(4) { width: 6%; }
        .detail-table th:nth-child(5), td:nth-child(5) { width: 8%; }
        .detail-table th:nth-child(6), td:nth-child(6) { width: 12%; }
        .detail-table th:nth-child(7), td:nth-child(7) { width: 12%; }
        .detail-table th:nth-child(8), td:nth-child(8) { width: 20%; }
        .detail-table .remark {
            text-align: left;
            padding-left: 5px;
        }

        /* 合计区域 */
        .total-area {
            margin: 10px 0;
            text-align: right;
            font-size: 14px;
        }
        .total-amount {
            font-size: 15px;
            font-weight: bold;
            color: #000;
            margin-left: 8px;
        }
        .amount-capital {
            margin-top: 4px;
            font-weight: 600;
        }

        /* 底部信息 */
        .footer {
            margin-top: 15px;
            font-size: 12px;
            color: #333;
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
        }
        .footer-left {
            text-align: left;
            width: 60%;
        }
        .footer-right {
            text-align: right;
            width: 40%;
        }

        /* 操作按钮 */
        .btn-group {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 9999;
            display: flex;
            gap: 10px;
        }
        .print-btn, .refresh-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            color: #fff;
        }
        .print-btn {
            background: #007fff;
        }
        .print-btn:hover {
            background: #0066cc;
        }
        .refresh-btn {
            background: #4CAF50;
        }
        .refresh-btn:hover {
            background: #3d8b40;
        }

        /* 提示信息 */
        .tip {
            margin: 10px 0;
            padding: 8px;
            background: #f5f5f5;
            border-left: 3px solid #007fff;
            font-size: 12px;
            color: #333;
        }
        .error-tip {
            background: #fff8f8;
            border-left: 3px solid #d32f2f;
            color: #d32f2f;
        }
    </style>
</head>
<body>
    <!-- 操作按钮（非打印元素） -->
    <div class="btn-group no-print">
        <button class="refresh-btn" onclick="loadSelectedData()">选择并加载数据</button>
        <button class="print-btn" onclick="printDocument()">打印选中数据</button>
    </div>

    <!-- 提示信息 -->
    <div class="tip no-print">
        操作说明：1. 点击「选择并加载数据」唤起记录选择对话框；2. 在对话框中选择要打印的记录并确认；3. 确认无误后点击「打印选中数据」
    </div>
    <div id="errorTip" class="tip error-tip no-print" style="display: none;"></div>

    <!-- 单据内容 -->
    <div class="invoice-container">
        <div class="title">河南省飞马起重机械集团有限公司销售明细表</div>

        <div class="base-info">
            <div class="info-item">
                <span class="info-label">发票号：</span>
                <span class="info-value" id="invoiceNo" contenteditable="true">2511054292</span>
            </div>
            <div class="info-item">
                <span class="info-label">发货日期：</span>
                <span class="info-value" id="shipDate" contenteditable="true">2025年11月28日</span>
            </div>
            <div class="info-item">
                <span class="info-label">销售经理：</span>
                <span class="info-value" id="salesManager" contenteditable="true">韩瑞鹏</span>
            </div>
            <div class="info-item">
                <span class="info-label">审核人员：</span>
                <span class="info-value" id="checker" contenteditable="true">韩瑞鹏</span>
            </div>
            <div class="info-item">
                <span class="info-label">发货人：</span>
                <span class="info-value" id="shipper" contenteditable="true">韩烁星（15670503456）</span>
            </div>
            <div class="info-item">
                <span class="info-label">收款方式：</span>
                <span class="info-value" id="paymentMethod" contenteditable="true">单</span>
            </div>
            <div class="info-item">
                <span class="info-label">客户名称：</span>
                <span class="info-value" id="customerName" contenteditable="true">中原公司靳庆余</span>
            </div>
            <div class="info-item">
                <span class="info-label">客户电话：</span>
                <span class="info-value" id="customerPhone" contenteditable="true">18603739577</span>
            </div>
        </div>

        <table class="detail-table">
            <thead>
                <tr>
                    <th>物料编码</th>
                    <th>物料名称</th>
                    <th>规格型号</th>
                    <th>单位</th>
                    <th>数量</th>
                    <th>单价（元）</th>
                    <th>金额（元）</th>
                    <th>备注</th>
                </tr>
            </thead>
            <tbody id="detailTableBody">
                <tr>
                    <td colspan="8" style="text-align: center; color: #666;">点击「选择并加载数据」唤起对话框选择记录</td>
                </tr>
            </tbody>
        </table>

        <div class="total-area">
            <div>
                数量合计：<span id="totalQuantity">0.00</span> 吨&nbsp;&nbsp;&nbsp;&nbsp;
                金额合计：<span class="total-amount" id="totalAmount">¥0.00</span>
            </div>
            <div class="amount-capital">
                大写金额：<span id="capitalAmount">零元整</span>
            </div>
            <div style="margin-top: 4px; font-size: 12px;">说明：此金额为含税价</div>
        </div>

        <div class="footer">
            <div class="footer-left">
                打印时间：<span id="printTime">2025年11月28日 09:47</span><br>
                单据联次：共4联（留存/客户/记账/会计）
            </div>
            <div class="footer-right">
                第 <span id="pageNum">1</span> 页 / 共 <span id="totalPage">1</span> 页
            </div>
        </div>
    </div>

    <script>
        // ========================= 核心配置：飞书表格字段映射 =========================
        // ！！！必须替换为你的表格实际字段ID（获取方式：飞书表格→字段设置→复制字段ID）
        const FIELD_MAPPING = {
            materialCode: "fld6mvGmkP", // 物料编码字段ID
            materialName: "fldTRySYAT", // 物料名称字段ID
            specification: "fld6mvGmkP", // 规格型号字段ID
            unit: "fld6mvGmkP", // 单位字段ID
            quantity: "fld6mvGmkP", // 数量字段ID
            unitPrice: "fld6mvGmkP", // 单价字段ID
            amount: "fld6mvGmkP", // 金额字段ID（可选）
            remark: "fld6mvGmkP" // 备注字段ID（可选）
        };
        // ===========================================================================

        // 金额大写转换工具
        function convertToCapital(amount) {
            const digits = ['零', '壹', '贰', '叁', '肆', '伍', '陆', '柒', '捌', '玖'];
            const units = ['', '拾', '佰', '仟', '万', '拾', '佰', '仟', '亿'];
            const decimals = ['角', '分'];
            let integerPart = Math.floor(amount);
            let decimalPart = Math.round((amount - integerPart) * 100);
            
            let capital = '';
            if (integerPart === 0) {
                capital = '零';
            } else {
                let str = integerPart.toString();
                for (let i = 0; i < str.length; i++) {
                    const digit = parseInt(str[i]);
                    const pos = str.length - 1 - i;
                    if (digit !== 0) {
                        capital += digits[digit] + units[pos];
                    } else {
                        if (pos % 4 !== 0 || (i > 0 && parseInt(str[i-1]) !== 0)) {
                            capital += digits[digit];
                        }
                    }
                }
            }
            capital += '元';
            if (decimalPart === 0) {
                capital += '整';
            } else {
                if (Math.floor(decimalPart / 10) > 0) {
                    capital += digits[Math.floor(decimalPart / 10)] + decimals[0];
                } else if (integerPart !== 0) {
                    capital += '零';
                }
                if (decimalPart % 10 > 0) {
                    capital += digits[decimalPart % 10] + decimals[1];
                }
            }
            return capital;
        }

        // 核心改造：通过selectRecordIdList唤起选择对话框获取记录ID并加载数据
        async function loadSelectedData() {
            const errorTip = document.getElementById('errorTip');
            const tableBody = document.getElementById('detailTableBody');
            
            try {
                // ========== 步骤1：检查SDK加载状态 ==========
                console.log('【步骤1】检查飞书SDK加载状态');
                if (!window.bitable || !window.bitable.base || !window.bitable.ui) {
                    throw new Error('飞书SDK加载失败，请确认lark-sdk.umd.js文件路径正确');
                }
                console.log('✅ SDK加载成功，bitable对象：', window.bitable);

                // ========== 步骤2：获取base实例 ==========
                console.log('【步骤2】获取base实例');
                const base = window.bitable.base;
                if (!base) {
                    throw new Error('未获取到base实例，请确认在飞书多维表格环境中运行');
                }
                console.log('✅ base实例获取成功：', base);

                // ========== 步骤3：获取tableId和viewId ==========
                console.log('【步骤3】获取当前活跃表格的tableId和viewId');
                // 获取选中信息（提取tableId和viewId）
                const selection = await base.getSelection();
                console.log('原始selection数据：', selection);
                
                let tableId = selection?.tableId;
                let viewId = selection?.viewId;
                
                // 兼容：如果selection中没有，从活跃表格获取
                if (!tableId) {
                    const activeTable = await base.getActiveTable();
                    tableId = activeTable?.id;
                    viewId = activeTable?.activeViewId || viewId;
                }
                
                if (!tableId || !viewId) {
                    throw new Error('未获取到tableId或viewId，请先打开飞书多维表格的具体视图');
                }
                console.log(`✅ tableId和viewId获取成功：tableId=${tableId}, viewId=${viewId}`);

                // ========== 步骤4：调用selectRecordIdList唤起选择对话框 ==========
                console.log('【步骤4】调用bitable.ui.selectRecordIdList唤起记录选择对话框');
                // 核心API：唤起选择对话框，返回选中的recordId列表
                const selectedRecordIds = await window.bitable.ui.selectRecordIdList(tableId, viewId);
                console.log('✅ 选择对话框返回的recordId列表：', selectedRecordIds);

                // 验证选中结果
                if (!selectedRecordIds || selectedRecordIds.length === 0) {
                    throw new Error('未在对话框中选择任何记录，请重新选择');
                }
                console.log(`✅ 共选中 ${selectedRecordIds.length} 条记录`);

                // ========== 步骤5：获取当前活跃表格实例 ==========
                console.log('【步骤5】获取当前活跃表格实例');
                const table = await base.getActiveTable();
                if (!table) {
                    throw new Error('未找到当前活跃表格');
                }
                console.log('✅ 表格实例获取成功：', table);

                // ========== 步骤6：获取表格所有记录 ==========
                console.log('【步骤6】获取表格所有记录');
                const allRecords = await table.getRecordList();
                console.log(`✅ 获取到表格所有记录，共 ${allRecords.length} 条：`, allRecords);

                // ========== 步骤7：筛选出选中的记录 ==========
                console.log('【步骤7】筛选选中的记录（根据recordId列表）');
                const selectedRecords = allRecords.filter(record => 
                    selectedRecordIds.includes(record.id)
                );
                console.log(`✅ 筛选出选中的记录，共 ${selectedRecords.length} 条：`, selectedRecords);

                // ========== 步骤8：验证字段映射配置 ==========
                console.log('【步骤8】验证字段映射配置');
                const requiredFields = ['materialCode', 'materialName', 'specification', 'quantity', 'unitPrice'];
                const missingFields = requiredFields.filter(key => 
                    !FIELD_MAPPING[key] || FIELD_MAPPING[key].includes('xxxx')
                );
                if (missingFields.length > 0) {
                    throw new Error(`请配置飞书表格字段映射：${missingFields.join('、')}（修改代码中FIELD_MAPPING配置）`);
                }
                console.log('✅ 字段映射配置验证通过');

                // ========== 步骤9：处理数据并渲染表格 ==========
                console.log('【步骤9】处理选中记录数据并渲染表格');
                let totalQuantity = 0;
                let totalAmount = 0;
                let tableHtml = '';

                // 辅助函数：通过字段ID获取单元格值
                const getCellValue = async (record, fieldId) => {
                    try {
                        const cell = await record.getCellByField(fieldId);
                        const value = cell ? await cell.getValue() : '';
                        console.log(`获取字段[${fieldId}]值：`, value);
                        return value;
                    } catch (e) {
                        console.warn(`获取字段${fieldId}值失败：`, e);
                        return '';
                    }
                };

                // 遍历选中记录
                for (let i = 0; i < selectedRecords.length; i++) {
                    const record = selectedRecords[i];
                    console.log(`处理第 ${i+1} 条记录（ID：${record.id}）`);

                    // 提取各字段值
                    const materialCode = await getCellValue(record, FIELD_MAPPING.materialCode) || '';
                    const materialName = await getCellValue(record, FIELD_MAPPING.materialName) || '';
                    const specification = await getCellValue(record, FIELD_MAPPING.specification) || '';
                    const unit = await getCellValue(record, FIELD_MAPPING.unit) || '吨';
                    const quantity = parseFloat(await getCellValue(record, FIELD_MAPPING.quantity)) || 0;
                    const unitPrice = parseFloat(await getCellValue(record, FIELD_MAPPING.unitPrice)) || 0;
                    // 修复原BUG：金额优先从字段获取，无则计算
                    const amountFieldValue = await getCellValue(record, FIELD_MAPPING.amount);
                    const amount = amountFieldValue ? parseFloat(amountFieldValue) : (quantity * unitPrice);
                    const remark = await getCellValue(record, FIELD_MAPPING.remark) || '';

                    // 累加合计
                    totalQuantity += quantity;
                    totalAmount += amount;

                    // 生成表格行HTML
                    tableHtml += `
                        <tr>
                            <td>${materialCode}</td>
                            <td>${materialName}</td>
                            <td>${specification}</td>
                            <td>${unit}</td>
                            <td>${quantity.toFixed(2)}</td>
                            <td>${unitPrice.toFixed(2)}</td>
                            <td>${amount.toFixed(2)}</td>
                            <td class="remark">${remark}</td>
                        </tr>
                    `;
                }

                // ========== 步骤10：更新页面显示 ==========
                console.log('【步骤10】更新表格和合计信息');
                // 更新表格内容
                tableBody.innerHTML = tableHtml;
                // 更新合计数据
                document.getElementById('totalQuantity').textContent = totalQuantity.toFixed(2);
                document.getElementById('totalAmount').textContent = `¥${totalAmount.toFixed(2)}`;
                // 更新大写金额
                document.getElementById('capitalAmount').textContent = convertToCapital(totalAmount);
                // 隐藏错误提示
                errorTip.style.display = 'none';

                console.log('✅ 所有数据加载完成，合计数量：', totalQuantity, '合计金额：', totalAmount);

            } catch (err) {
                // 异常处理：显示错误提示 + 控制台打印
                console.error('❌ 加载数据失败：', err);
                errorTip.textContent = `错误：${err.message}`;
                errorTip.style.display = 'block';
                tableBody.innerHTML = `<tr><td colspan="8" style="text-align: center; color: #d32f2f;">${err.message}</td></tr>`;
            }
        }

        // 打印功能（飞书/浏览器兼容）
        function printDocument() {
            const tableBody = document.getElementById('detailTableBody');
            const errorTip = document.getElementById('errorTip');

            console.log('【打印功能】触发打印操作');
            // 检查是否有有效数据
            if (tableBody.querySelector('td[colspan="8"]') || tableBody.children.length === 0) {
                const errMsg = '无有效打印数据，请先选择并加载数据';
                console.error('❌ 打印失败：', errMsg);
                errorTip.textContent = `错误：${errMsg}`;
                errorTip.style.display = 'block';
                return;
            }

            // 飞书环境优先使用飞书打印API
            if (window.bitable && window.bitable.base) {
                try {
                    console.log('尝试调用飞书内置打印API');
                    window.bitable.base.print({
                        success: () => console.log('✅ 飞书打印触发成功'),
                        fail: (err) => {
                            console.error('❌ 飞书打印失败，切换为浏览器打印：', err);
                            window.print();
                        }
                    });
                } catch (e) {
                    console.warn('⚠️ 飞书打印API调用失败，使用浏览器打印：', e);
                    window.print();
                }
            } else {
                console.log('非飞书环境，使用浏览器打印');
                window.print();
            }
        }

        // 初始化：更新打印时间 + 检查飞书环境
        window.onload = function() {
            console.log('【初始化】页面加载完成，执行初始化操作');
            // 更新当前打印时间
            const now = new Date();
            const formatTime = `${now.getFullYear()}年${now.getMonth()+1}月${now.getDate()}日 ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            document.getElementById('printTime').textContent = formatTime;
            console.log(`✅ 打印时间已更新为：${formatTime}`);

            // 检查飞书环境
            if (window.bitable && window.bitable.base) {
                console.log('✅ 检测到飞书环境，初始化完成');
            } else {
                console.warn('⚠️ 未检测到飞书环境，部分功能可能无法使用');
            }
        };
    </script>
</body>
</html>
