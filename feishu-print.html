<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>销售明细表 - 飞书打印版</title>
 <script src="lark-sdk.umd.js" defer></script>
    <style>
        /* 保持原有样式不变 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "仿宋", "SimSun", serif;
        }
        body {
            width: 241mm;
            padding: 8mm 10mm;
            margin: 0 auto;
            background: #fff;
            font-size: 13px;
            line-height: 1.4;
        }
        @media print {
            .no-print { display: none !important; }
            @page { size: 241mm 279.4mm; margin: 8mm 10mm; }
            th, td { border-color: #000 !important; }
        }
        .title { text-align: center; font-size: 18px; font-weight: bold; margin: 10px 0; }
        .base-info { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px 15px; margin-bottom: 10px; border-bottom: 1px solid #000; padding-bottom: 8px; }
        .info-item { display: flex; }
        .info-label { width: 75px; font-weight: 600; }
        .info-value { flex: 1; border-bottom: 1px dashed #333; padding: 1px 0; }
        .detail-table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        .detail-table th, .detail-table td { border: 1px solid #000; padding: 6px 3px; text-align: center; font-size: 12px; }
        .detail-table th:nth-child(1) { width: 12%; }
        .detail-table th:nth-child(2) { width: 12%; }
        .detail-table th:nth-child(3) { width: 18%; }
        .detail-table th:nth-child(4) { width: 6%; }
        .detail-table th:nth-child(5) { width: 8%; }
        .detail-table th:nth-child(6) { width: 12%; }
        .detail-table th:nth-child(7) { width: 12%; }
        .detail-table th:nth-child(8) { width: 20%; }
        .total-area { text-align: right; margin: 10px 0; }
        .total-amount { font-weight: bold; margin-left: 8px; }
        .footer { display: flex; justify-content: space-between; margin-top: 15px; font-size: 12px; }
        .btn-group { position: fixed; top: 15px; right: 15px; z-index: 9999; display: flex; gap: 10px; }
        .print-btn, .refresh-btn { padding: 8px 16px; border: none; border-radius: 4px; color: #fff; cursor: pointer; }
        .print-btn { background: #007fff; }
        .refresh-btn { background: #4CAF50; }
        .tip { margin: 10px 0; padding: 8px; border-left: 3px solid #007fff; font-size: 12px; }
        .error-tip { background: #fff8f8; border-left: 3px solid #d32f2f; color: #d32f2f; }
        .debug-log { margin: 5px 0; padding: 5px; font-size: 11px; background: #f9f9f9; border-radius: 3px; } /* 新增调试日志样式 */
    </style>
</head>
<body>
    <div class="btn-group no-print">
        <button class="refresh-btn" onclick="loadSelectedData()">刷新选中数据</button>
        <button class="print-btn" onclick="printDocument()">打印选中数据</button>
    </div>

    <div class="tip no-print">
        操作步骤：1. 确保在「表格视图」中；2. 点击行首复选框选中行；3. 点击「刷新选中数据」
    </div>
    <div id="errorTip" class="tip error-tip no-print" style="display: none;"></div>
    <!-- 新增调试信息区域（仅开发时可见） -->
    <div id="debugArea" class="no-print" style="display: none; margin: 10px 0;"></div>

    <div class="invoice-container">
        <div class="title">河南省飞马起重机械集团有限公司销售明细表</div>

        <div class="base-info">
            <div class="info-item"><span class="info-label">发票号：</span><span class="info-value" id="invoiceNo" contenteditable="true">2511054292</span></div>
            <div class="info-item"><span class="info-label">发货日期：</span><span class="info-value" id="shipDate" contenteditable="true">2025年11月28日</span></div>
            <div class="info-item"><span class="info-label">销售经理：</span><span class="info-value" id="salesManager" contenteditable="true">韩瑞鹏</span></div>
            <div class="info-item"><span class="info-label">审核人员：</span><span class="info-value" id="checker" contenteditable="true">韩瑞鹏</span></div>
            <div class="info-item"><span class="info-label">发货人：</span><span class="info-value" id="shipper" contenteditable="true">韩烁星（15670503456）</span></div>
            <div class="info-item"><span class="info-label">收款方式：</span><span class="info-value" id="paymentMethod" contenteditable="true">单</span></div>
            <div class="info-item"><span class="info-label">客户名称：</span><span class="info-value" id="customerName" contenteditable="true">中原公司靳庆余</span></div>
            <div class="info-item"><span class="info-label">客户电话：</span><span class="info-value" id="customerPhone" contenteditable="true">18603739577</span></div>
        </div>

        <table class="detail-table">
            <thead>
                <tr>
                    <th>物料编码</th>
                    <th>物料名称</th>
                    <th>规格型号</th>
                    <th>单位</th>
                    <th>数量</th>
                    <th>单价（元）</th>
                    <th>金额（元）</th>
                    <th>备注</th>
                </tr>
            </thead>
            <tbody id="detailTableBody">
                <tr><td colspan="8" style="text-align: center; color: #666;">请先选中行并刷新数据</td></tr>
            </tbody>
        </table>

        <div class="total-area">
            <div>数量合计：<span id="totalQuantity">0.00</span> 吨&nbsp;&nbsp;金额合计：<span class="total-amount" id="totalAmount">¥0.00</span></div>
            <div class="amount-capital">大写金额：<span id="capitalAmount">零元整</span></div>
        </div>

        <div class="footer">
            <div class="footer-left">打印时间：<span id="printTime">2025年11月28日 09:47</span><br>单据联次：共4联</div>
            <div class="footer-right">第 <span id="pageNum">1</span> 页 / 共 <span id="totalPage">1</span> 页</div>
        </div>
    </div>

    <script>
        // 全局变量：存储选中行ID
        let selectedRecordIds = [];
        // 字段映射（必须替换为你的实际字段ID！）
        const FIELD_MAPPING = {
            materialCode: "fld实际物料编码ID", // 示例：fldABC123（需替换）
            materialName: "fld实际物料名称ID",
            specification: "fld实际规格ID",
            unit: "fld实际单位ID",
            quantity: "fld实际数量ID",
            unitPrice: "fld实际单价ID",
            remark: "fld实际备注ID"
        };

        // 调试日志工具（显示在页面上，方便非开发者查看）
        function addDebugLog(message) {
            const debugArea = document.getElementById('debugArea');
            debugArea.style.display = 'block';
            const logItem = document.createElement('div');
            logItem.className = 'debug-log';
            logItem.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            debugArea.appendChild(logItem);
            // 只保留最近10条日志
            if (debugArea.children.length > 10) {
                debugArea.removeChild(debugArea.firstChild);
            }
        }

        // 金额大写转换
        function convertToCapital(amount) {
            const digits = ['零', '壹', '贰', '叁', '肆', '伍', '陆', '柒', '捌', '玖'];
            const units = ['', '拾', '佰', '仟', '万', '拾', '佰', '仟', '亿'];
            const decimals = ['角', '分'];
            let integerPart = Math.floor(amount);
            let decimalPart = Math.round((amount - integerPart) * 100);
            
            let capital = '';
            if (integerPart === 0) capital = '零';
            else {
                let str = integerPart.toString();
                for (let i = 0; i < str.length; i++) {
                    const digit = parseInt(str[i]);
                    const pos = str.length - 1 - i;
                    if (digit !== 0) capital += digits[digit] + units[pos];
                    else if (pos % 4 !== 0 || (i > 0 && parseInt(str[i-1]) !== 0)) capital += digits[digit];
                }
            }
            capital += '元';
            if (decimalPart === 0) capital += '整';
            else {
                if (Math.floor(decimalPart / 10) > 0) capital += digits[Math.floor(decimalPart / 10)] + decimals[0];
                else if (integerPart !== 0) capital += '零';
                if (decimalPart % 10 > 0) capital += digits[decimalPart % 10] + decimals[1];
            }
            return capital;
        }

        // 初始化选中事件监听（严格遵循SDK文档规范）
        async function initSelectionListener() {
            try {
                addDebugLog('开始初始化选中事件监听...');
                
                // 1. 等待SDK加载完成（最多等8秒，每1秒检查一次）
                let waitCount = 0;
                while (!window.bitable || !window.bitable.base) {
                    if (waitCount >= 80) { // 80 * 100ms = 8秒
                        throw new Error('飞书SDK加载超时，请检查网络或重新打开页面');
                    }
                    await new Promise(resolve => setTimeout(resolve, 100));
                    waitCount++;
                }
                addDebugLog('飞书SDK加载成功');

                // 2. 获取Base实例并检查权限（关键步骤）
                const base = window.bitable.base;
                const authStatus = await base.getAuthStatus(); // 官方权限检查API
                addDebugLog(`当前插件权限：${JSON.stringify(authStatus)}`);
                if (!authStatus.includes('bitable:readonly')) {
                    throw new Error('插件缺少「bitable:readonly」权限，请在飞书开发者后台配置并重新安装插件');
                }

                // 3. 绑定选中事件（严格按文档格式）
                base.onSelectionChange((selection) => {
                    addDebugLog(`选中事件触发，原始数据：${JSON.stringify(selection)}`);
                    
                    // 提取选中ID（覆盖文档中所有可能的格式）
                    let ids = [];
                    if (Array.isArray(selection.recordIds)) {
                        ids = selection.recordIds; // 标准格式：数组
                    } else if (typeof selection.recordId === 'string') {
                        ids = [selection.recordId]; // 单行选中格式
                    } else if (Array.isArray(selection.records)) {
                        ids = selection.records.map(r => r.id); // 包含完整记录的格式
                    }

                    selectedRecordIds = ids;
                    addDebugLog(`解析后选中行ID：${ids.length > 0 ? ids.join(',') : '无'}`);
                });

                addDebugLog('选中事件监听初始化成功（可开始选中行）');
            } catch (err) {
                const errorMsg = `监听初始化失败：${err.message}`;
                addDebugLog(errorMsg);
                document.getElementById('errorTip').textContent = errorMsg;
                document.getElementById('errorTip').style.display = 'block';
            }
        }

        // 加载选中数据（完全遵循官方API流程）
        async function loadSelectedData() {
            const errorTip = document.getElementById('errorTip');
            const tableBody = document.getElementById('detailTableBody');
            errorTip.style.display = 'none';
            addDebugLog('开始加载选中数据...');

            try {
                // 1. 检查SDK实例
                if (!window.bitable || !window.bitable.base) {
                    throw new Error('飞书SDK未初始化，请刷新页面重试');
                }
                const base = window.bitable.base;

                // 2. 获取当前活跃表格（官方推荐方式）
                addDebugLog('尝试获取当前活跃表格...');
                const table = await base.getActiveTable();
                if (!table) {
                    throw new Error('未找到活跃表格，请确认在飞书多维表格的「表格视图」中打开');
                }
                addDebugLog(`获取表格成功，表格ID：${table.id}`);

                // 3. 双重校验选中ID（事件缓存 + 主动查询）
                let ids = selectedRecordIds;
                if (ids.length === 0) {
                    addDebugLog('缓存中无选中ID，尝试主动调用getSelection()...');
                    const selection = await base.getSelection(); // 官方主动查询API
                    addDebugLog(`getSelection返回数据：${JSON.stringify(selection)}`);
                    
                    // 解析主动查询结果
                    if (Array.isArray(selection.recordIds)) {
                        ids = selection.recordIds;
                    } else if (typeof selection.recordId === 'string') {
                        ids = [selection.recordId];
                    } else if (Array.isArray(selection.records)) {
                        ids = selection.records.map(r => r.id);
                    }
                }

                // 4. 验证选中状态
                if (ids.length === 0) {
                    throw new Error(`未检测到选中行！可能原因：
1. 未在「表格视图」中操作（仅表格视图支持行选中）
2. 选中后未刷新（请重新勾选行首复选框并点击刷新）
3. 表格无数据或选中行被筛选隐藏（清除筛选后重试）`);
                }
                addDebugLog(`最终选中行ID：${ids.join(',')}`);

                // 5. 获取并筛选记录（官方Record API）
                addDebugLog('开始获取表格记录...');
                const allRecords = await table.getRecordList(); // 获取所有记录
                addDebugLog(`表格共${allRecords.length}条记录，筛选选中行...`);
                const selectedRecords = allRecords.filter(record => ids.includes(record.id));

                if (selectedRecords.length === 0) {
                    throw new Error('选中行ID在表格中未找到对应记录（可能已被删除或筛选隐藏）');
                }

                // 6. 渲染表格数据
                let totalQuantity = 0, totalAmount = 0, tableHtml = '';
                for (const record of selectedRecords) {
                    // 封装字段获取方法（兼容官方API）
                    const getFieldValue = async (fieldKey) => {
                        const fieldId = FIELD_MAPPING[fieldKey];
                        if (!fieldId || fieldId.includes('实际')) {
                            throw new Error(`未配置正确的字段ID：${fieldKey}（请修改FIELD_MAPPING）`);
                        }
                        const cell = await record.getCellByField(fieldId);
                        return cell ? await cell.getValue() : '';
                    };

                    const materialCode = await getFieldValue('materialCode') || '';
                    const materialName = await getFieldValue('materialName') || '';
                    const specification = await getFieldValue('specification') || '';
                    const unit = await getFieldValue('unit') || '吨';
                    const quantity = parseFloat(await getFieldValue('quantity')) || 0;
                    const unitPrice = parseFloat(await getFieldValue('unitPrice')) || 0;
                    const amount = quantity * unitPrice;
                    const remark = await getFieldValue('remark') || '';

                    totalQuantity += quantity;
                    totalAmount += amount;

                    tableHtml += `
                        <tr>
                            <td>${materialCode}</td>
                            <td>${materialName}</td>
                            <td>${specification}</td>
                            <td>${unit}</td>
                            <td>${quantity.toFixed(2)}</td>
                            <td>${unitPrice.toFixed(2)}</td>
                            <td>${amount.toFixed(2)}</td>
                            <td>${remark}</td>
                        </tr>
                    `;
                }

                // 更新页面
                tableBody.innerHTML = tableHtml;
                document.getElementById('totalQuantity').textContent = totalQuantity.toFixed(2);
                document.getElementById('totalAmount').textContent = `¥${totalAmount.toFixed(2)}`;
                document.getElementById('capitalAmount').textContent = convertToCapital(totalAmount);
                addDebugLog('数据加载成功，共渲染' + selectedRecords.length + '行');

            } catch (err) {
                const errorMsg = `错误：${err.message}`;
                addDebugLog(errorMsg);
                errorTip.textContent = errorMsg;
                errorTip.style.display = 'block';
                tableBody.innerHTML = `<tr><td colspan="8" style="text-align: center; color: #d32f2f;">${err.message}</td></tr>`;
            }
        }

        // 打印功能（兼容官方API）
        function printDocument() {
            const tableBody = document.getElementById('detailTableBody');
            if (tableBody.querySelector('td[colspan="8"]') || tableBody.children.length === 0) {
                const errorMsg = '无数据可打印，请先加载选中数据';
                document.getElementById('errorTip').textContent = errorMsg;
                document.getElementById('errorTip').style.display = 'block';
                addDebugLog(errorMsg);
                return;
            }

            // 优先使用飞书打印API，失败则降级为浏览器打印
            if (window.bitable?.base) {
                addDebugLog('尝试调用飞书打印API...');
                window.bitable.base.print({
                    success: () => addDebugLog('飞书打印成功触发'),
                    fail: (err) => {
                        addDebugLog(`飞书打印API调用失败：${err.message}，切换为浏览器打印`);
                        window.print();
                    }
                });
            } else {
                addDebugLog('未检测到飞书环境，使用浏览器打印');
                window.print();
            }
        }

        // 初始化入口（确保DOM和SDK加载完成）
        window.addEventListener('DOMContentLoaded', async () => {
            // 更新打印时间
            const now = new Date();
            document.getElementById('printTime').textContent = `${now.getFullYear()}年${now.getMonth()+1}月${now.getDate()}日 ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            
            // 启动事件监听
            await initSelectionListener();

            // 提示用户操作
            addDebugLog('初始化完成，请在表格中选中行后点击「刷新选中数据」');
        });
    </script>
</body>
</html>
