<script>
    // ==================== 辅助函数 ====================
    
    // 金额大写转换工具
    function convertToCapital(amount) {
        const digits = ['零', '壹', '贰', '叁', '肆', '伍', '陆', '柒', '捌', '玖'];
        const units = ['', '拾', '佰', '仟', '万', '拾', '佰', '仟', '亿'];
        const decimals = ['角', '分'];
        
        // 处理负数
        let isNegative = false;
        if (amount < 0) {
            isNegative = true;
            amount = Math.abs(amount);
        }
        
        let integerPart = Math.floor(amount);
        let decimalPart = Math.round((amount - integerPart) * 100);
        
        let capital = '';
        if (integerPart === 0) {
            capital = '零';
        } else {
            let str = integerPart.toString();
            for (let i = 0; i < str.length; i++) {
                const digit = parseInt(str[i]);
                const pos = str.length - 1 - i;
                if (digit !== 0) {
                    capital += digits[digit] + units[pos];
                } else {
                    if (pos % 4 !== 0 || (i > 0 && parseInt(str[i-1]) !== 0)) {
                        capital += digits[digit];
                    }
                }
            }
        }
        capital += '元';
        if (decimalPart === 0) {
            capital += '整';
        } else {
            if (Math.floor(decimalPart / 10) > 0) {
                capital += digits[Math.floor(decimalPart / 10)] + decimals[0];
            } else if (integerPart !== 0) {
                capital += '零';
            }
            if (decimalPart % 10 > 0) {
                capital += digits[decimalPart % 10] + decimals[1];
            }
        }
        
        return (isNegative ? '负' : '') + capital;
    }

    // 时间戳转日期格式（处理毫秒时间戳）
    function timestampToDate(timestamp) {
        if (!timestamp) return '';
        
        // 如果是毫秒时间戳，转换为秒
        if (timestamp > 1000000000000) {
            timestamp = Math.floor(timestamp / 1000);
        }
        
        const date = new Date(timestamp * 1000);
        const year = date.getFullYear();
        const month = date.getMonth() + 1;
        const day = date.getDate();
        
        return `${year}年${month}月${day}日`;
    }

    // 改进的字段提取函数，支持各种数据结构
    function getFieldValue(fields, fieldPath) {
        if (!fields || typeof fields !== 'object') {
            console.warn('fields 为空或不是对象:', fields);
            return '';
        }
        
        console.log(`尝试获取字段: ${fieldPath}`);
        console.log('当前 fields:', fields);
        
        // 特殊处理：如果字段路径中没有点号或方括号，直接返回字段值
        if (!fieldPath.includes('.') && !fieldPath.includes('[')) {
            const value = fields[fieldPath];
            console.log(`直接获取字段 ${fieldPath}:`, value);
            
            // 如果是数组，返回第一个元素的text属性
            if (Array.isArray(value) && value.length > 0) {
                if (typeof value[0] === 'object' && value[0].text !== undefined) {
                    return value[0].text;
                }
                return value[0];
            }
            
            // 如果是对象且有text属性
            if (typeof value === 'object' && value !== null && value.text !== undefined) {
                return value.text;
            }
            
            return value || '';
        }
        
        // 处理带路径的字段
        let value = fields;
        const pathParts = fieldPath.split('.');
        
        for (let i = 0; i < pathParts.length; i++) {
            const part = pathParts[i];
            
            // 处理数组索引，如 [0]
            if (part.includes('[')) {
                const arrayMatch = part.match(/(\w+)\[(\d+)\]/);
                if (arrayMatch) {
                    const fieldName = arrayMatch[1];
                    const index = parseInt(arrayMatch[2]);
                    
                    console.log(`处理数组字段: ${fieldName}[${index}]`);
                    
                    if (value && value[fieldName] && Array.isArray(value[fieldName])) {
                        if (value[fieldName][index] !== undefined) {
                            value = value[fieldName][index];
                            console.log(`获取到数组元素:`, value);
                        } else {
                            console.warn(`数组索引 ${index} 超出范围`);
                            return '';
                        }
                    } else {
                        console.warn(`字段 ${fieldName} 不存在或不是数组`);
                        return '';
                    }
                }
            } 
            // 处理普通属性
            else {
                console.log(`获取属性: ${part}`);
                if (value && typeof value === 'object' && part in value) {
                    value = value[part];
                } else {
                    console.warn(`属性 ${part} 不存在`);
                    return '';
                }
            }
            
            if (value === null || value === undefined) {
                return '';
            }
        }
        
        console.log(`最终获取的值:`, value);
        
        // 如果值是对象且有 text 属性，返回 text
        if (typeof value === 'object' && value !== null && value.text !== undefined) {
            console.log(`返回 text 属性: ${value.text}`);
            return value.text;
        }
        
        return value;
    }

    // 更简单的字段提取函数（备用方案）
    function extractField(fields, fieldId) {
        if (!fields || !fieldId) return '';
        
        const fieldValue = fields[fieldId];
        console.log(`提取字段 ${fieldId}:`, fieldValue);
        
        if (!fieldValue) return '';
        
        // 如果是数组
        if (Array.isArray(fieldValue) && fieldValue.length > 0) {
            // 数组元素是对象且有text属性
            if (typeof fieldValue[0] === 'object' && fieldValue[0].text !== undefined) {
                return fieldValue[0].text;
            }
            // 数组元素是时间戳
            else if (typeof fieldValue[0] === 'number') {
                return fieldValue[0];
            }
            // 其他情况返回第一个元素
            else {
                return fieldValue[0];
            }
        }
        // 如果是对象且有text属性
        else if (typeof fieldValue === 'object' && fieldValue !== null && fieldValue.text !== undefined) {
            return fieldValue.text;
        }
        // 其他情况直接返回值
        else {
            return fieldValue;
        }
    }

    // 更新打印时间
    function updatePrintTime() {
        const now = new Date();
        const formatTime = `${now.getFullYear()}年${now.getMonth()+1}月${now.getDate()}日 ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
        document.getElementById('printTime').textContent = formatTime;
        return formatTime;
    }

    // ==================== 核心函数 ====================
    
    // 核心改造：通过selectRecordIdList唤起选择对话框获取记录ID并加载数据
    async function loadSelectedData() {
        const errorTip = document.getElementById('errorTip');
        const tableBody = document.getElementById('detailTableBody');
        
        try {
            // ========== 步骤1：检查SDK加载状态 ==========
            console.log('【步骤1】检查飞书SDK加载状态');
            if (!window.bitable || !window.bitable.base || !window.bitable.ui) {
                throw new Error('飞书SDK加载失败，请确认lark-sdk.umd.js文件路径正确');
            }
            console.log('✅ SDK加载成功，bitable对象：', window.bitable);

            // ========== 步骤2：获取base实例 ==========
            console.log('【步骤2】获取base实例');
            const base = window.bitable.base;
            if (!base) {
                throw new Error('未获取到base实例，请确认在飞书多维表格环境中运行');
            }
            console.log('✅ base实例获取成功：', base);

            // ========== 步骤3：获取tableId和viewId ==========
            console.log('【步骤3】获取当前活跃表格的tableId和viewId');
            const selection = await base.getSelection();
            console.log('原始selection数据：', selection);
            
            let tableId = selection?.tableId;
            let viewId = selection?.viewId;
            
            // 兼容：如果selection中没有，从活跃表格获取
            if (!tableId) {
                const activeTable = await base.getActiveTable();
                tableId = activeTable?.id;
                viewId = activeTable?.activeViewId || viewId;
            }
            
            if (!tableId || !viewId) {
                throw new Error('未获取到tableId或viewId，请先打开飞书多维表格的具体视图');
            }
            console.log(`✅ tableId和viewId获取成功：tableId=${tableId}, viewId=${viewId}`);

            // ========== 步骤4：调用selectRecordIdList唤起选择对话框 ==========
            console.log('【步骤4】调用bitable.ui.selectRecordIdList唤起记录选择对话框');
            const selectedRecordIds = await window.bitable.ui.selectRecordIdList(tableId, viewId);
            console.log('✅ 选择对话框返回的recordId列表：', selectedRecordIds);

            // 验证选中结果
            if (!selectedRecordIds || selectedRecordIds.length === 0) {
                throw new Error('未在对话框中选择任何记录，请重新选择');
            }
            console.log(`✅ 共选中 ${selectedRecordIds.length} 条记录`);

            // ========== 步骤5：获取当前活跃表格实例 ==========
            console.log('【步骤5】获取当前活跃表格实例');
            const table = await base.getActiveTable();
            if (!table) {
                throw new Error('未找到当前活跃表格');
            }
            console.log('✅ 表格实例获取成功：', table);

            // ========== 步骤6：获取表格所有记录 ==========
            console.log('【步骤6】获取表格所有记录');
            let allRecords = await table.getRecordList();
            console.log('原始getRecordList返回值：', allRecords, '类型：', typeof allRecords, '是否数组：', Array.isArray(allRecords));

            // 关键调整：优先提取recordList
            if (!Array.isArray(allRecords)) {
                if (allRecords?.recordList && Array.isArray(allRecords.recordList)) {
                    allRecords = allRecords.recordList;
                }
                else if (allRecords?.records && Array.isArray(allRecords.records)) {
                    allRecords = allRecords.records;
                } else if (allRecords?.data && Array.isArray(allRecords.data)) {
                    allRecords = allRecords.data;
                }
                else {
                    allRecords = [];
                }
                console.log('转换后的allRecords数组：', allRecords, '长度：', allRecords.length);
            }

            if (allRecords.length === 0) {
                console.warn('⚠️ 警告：表格记录数组为空');
            } else {
                console.log(`✅ 成功提取记录数组，共 ${allRecords.length} 条记录`);
            }

            // ========== 步骤7：筛选选中的记录 ==========
            console.log('【步骤7】筛选选中的记录（根据recordId列表）');
            // 打印第一条记录的结构，确认fields字段
            if (allRecords.length > 0) {
                console.log('第一条记录的完整结构：', allRecords[0]);
                console.log('第一条记录的fields字段：', allRecords[0].fields);
                console.log('fields字段的所有键名：', Object.keys(allRecords[0].fields || {}));
            }

            // 修正筛选条件：使用recordId字段（根据实际情况调整）
            const selectedRecords = allRecords.filter(record => {
                const recordId = record.recordId || record.id || record._id;
                
                if (!recordId) {
                    console.warn('⚠️ 跳过无id的异常记录：', record);
                    return false;
                }
                return selectedRecordIds.includes(recordId);
            });

            console.log(`✅ 筛选出选中的记录，共 ${selectedRecords.length} 条`);

            if (selectedRecords.length === 0) {
                throw new Error('未找到匹配的记录，请检查字段映射');
            }

            // ========== 步骤8：处理数据并渲染 ==========
            console.log('【步骤8】处理数据并渲染');
            let totalAmount = 0;
            let tableHtml = '';
            let taxRemark = '';

            // 清空不需要展示的字段
            document.getElementById('checker').textContent = '';
            document.getElementById('shipper').textContent = '';
            document.getElementById('paymentMethod').textContent = '';
            document.getElementById('customerPhone').textContent = '';

            // 遍历选中记录
            for (let i = 0; i < selectedRecords.length; i++) {
                const record = selectedRecords[i];
                const fields = record.fields || {};
                console.log(`处理第 ${i+1} 条记录，fields：`, fields);

                // 如果是第一条记录，提取去重展示的字段
                if (i === 0) {
                    console.log('=== 提取去重展示字段 ===');
                    
                    // 发票号：fldFRpsxIn.text
                    const invoiceNo = extractField(fields, 'fldFRpsxIn') || '';
                    console.log('提取发票号:', invoiceNo);
                    document.getElementById('invoiceNo').textContent = invoiceNo;
                    
                    // 发货日期：fldXDRjMOt[0]（时间戳转日期）
                    const timestamp = extractField(fields, 'fldXDRjMOt');
                    console.log('提取时间戳:', timestamp);
                    const shipDate = timestampToDate(timestamp);
                    document.getElementById('shipDate').textContent = shipDate;
                    
                    // 销售经理：fldD0DvgRD[0].text
                    const salesManager = extractField(fields, 'fldD0DvgRD') || '';
                    console.log('提取销售经理:', salesManager);
                    document.getElementById('salesManager').textContent = salesManager;
                    
                    // 客户名称：fldfsZTsu9[0].text
                    const customerName = extractField(fields, 'fldfsZTsu9') || '';
                    console.log('提取客户名称:', customerName);
                    document.getElementById('customerName').textContent = customerName;
                    
                    // 含税说明：fldzNp2Gpg[0].text
                    const taxType = extractField(fields, 'fldzNp2Gpg') || '';
                    console.log('提取税类型:', taxType);
                    if (taxType === '含税') {
                        taxRemark = '说明：此金额为含税价';
                    }
                }

                // 提取表格行字段
                console.log('=== 提取表格行字段 ===');
                
                const materialCode = extractField(fields, 'fldYsLLAyK') || '';
                console.log('物料编码:', materialCode);
                
                const materialName = extractField(fields, 'fldZRE1MMR') || '';
                console.log('物料名称:', materialName);
                
                const specification = extractField(fields, 'fldTRySYAT') || '';
                console.log('规格型号:', specification);
                
                const unit = extractField(fields, 'fldNQg0P9l') || '';
                console.log('单位:', unit);
                
                // 数值字段直接获取
                const quantity = parseFloat(fields.fldLgfZ4zt) || 0;
                console.log('数量:', quantity, '原始值:', fields.fldLgfZ4zt);
                
                const unitPrice = parseFloat(fields.fldIeO9wYh) || 0;
                console.log('单价:', unitPrice, '原始值:', fields.fldIeO9wYh);
                
                const amount = parseFloat(fields.fldPnhczuU) || 0;
                console.log('金额:', amount, '原始值:', fields.fldPnhczuU);
                
                const remark = fields.fldQSFfBoE || '';
                console.log('备注:', remark);

                // 累加合计金额
                totalAmount += amount;

                // 生成表格行HTML
                tableHtml += `
                    <tr>
                        <td>${materialCode}</td>
                        <td>${materialName}</td>
                        <td>${specification}</td>
                        <td>${unit}</td>
                        <td>${quantity.toFixed(2)}</td>
                        <td>${unitPrice.toFixed(2)}</td>
                        <td>${amount.toFixed(2)}</td>
                        <td class="remark">${remark}</td>
                    </tr>
                `;
            }

            // ========== 步骤9：更新页面显示 ==========
            console.log('【步骤9】更新页面显示');
            // 更新表格内容
            tableBody.innerHTML = tableHtml;
            
            // 更新合计数据
            document.getElementById('totalAmount').textContent = `¥${totalAmount.toFixed(2)}`;
            document.getElementById('capitalAmount').textContent = convertToCapital(totalAmount);
            document.getElementById('taxRemark').textContent = taxRemark;
            
            // 更新打印时间
            updatePrintTime();
            
            // 隐藏错误提示
            errorTip.style.display = 'none';

            console.log('✅ 所有数据加载完成，合计金额：', totalAmount);

        } catch (err) {
            // 异常处理：显示错误提示 + 控制台打印
            console.error('❌ 加载数据失败：', err);
            errorTip.textContent = `错误：${err.message}`;
            errorTip.style.display = 'block';
            tableBody.innerHTML = `<tr><td colspan="8" style="text-align: center; color: #d32f2f;">${err.message}</td></tr>`;
        }
    }

    // 打印功能（飞书/浏览器兼容）
    function printDocument() {
        const tableBody = document.getElementById('detailTableBody');
        const errorTip = document.getElementById('errorTip');

        console.log('【打印功能】触发打印操作');
        // 检查是否有有效数据
        if (tableBody.querySelector('td[colspan="8"]') || tableBody.children.length === 0) {
            const errMsg = '无有效打印数据，请先选择并加载数据';
            console.error('❌ 打印失败：', errMsg);
            errorTip.textContent = `错误：${errMsg}`;
            errorTip.style.display = 'block';
            return;
        }

        // 更新打印时间
        updatePrintTime();

        // 飞书环境优先使用飞书打印API
        if (window.bitable && window.bitable.base) {
            try {
                console.log('尝试调用飞书内置打印API');
                window.bitable.base.print({
                    success: () => console.log('✅ 飞书打印触发成功'),
                    fail: (err) => {
                        console.error('❌ 飞书打印失败，切换为浏览器打印：', err);
                        window.print();
                    }
                });
            } catch (e) {
                console.warn('⚠️ 飞书打印API调用失败，使用浏览器打印：', e);
                window.print();
            }
        } else {
            console.log('非飞书环境，使用浏览器打印');
            window.print();
        }
    }

    // 初始化：更新打印时间
    window.onload = function() {
        console.log('【初始化】页面加载完成，执行初始化操作');
        updatePrintTime();
        
        // 清空初始显示内容
        document.getElementById('checker').textContent = '';
        document.getElementById('shipper').textContent = '';
        document.getElementById('paymentMethod').textContent = '';
        document.getElementById('customerPhone').textContent = '';
        document.getElementById('taxRemark').textContent = '';

        // 检查飞书环境
        if (window.bitable && window.bitable.base) {
            console.log('✅ 检测到飞书环境，初始化完成');
        } else {
            console.warn('⚠️ 未检测到飞书环境，部分功能可能无法使用');
        }
    };
</script>
